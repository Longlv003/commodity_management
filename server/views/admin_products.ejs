<!DOCTYPE html>
<html class="dark" lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Quản lý sản phẩm - Admin</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.8);
        border-radius: 9999px;
      }
    </style>
  </head>

  <body class="bg-slate-950 text-slate-100">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside
        class="hidden md:flex w-64 flex-col border-r border-slate-800 bg-slate-950/80 backdrop-blur"
      >
        <div class="flex items-center gap-3 px-6 pt-6 pb-4">
          <div
            class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-600 text-lg font-black"
          >
            CH
          </div>
          <div>
            <p class="text-sm text-slate-400">Admin</p>
            <p class="text-base font-semibold">ClosetHub Panel</p>
          </div>
        </div>

        <nav class="mt-4 flex-1 px-3 space-y-1">
          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl">space_dashboard</span>
            <span>Dashboard</span>
          </a>

          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm bg-slate-800 text-white"
          >
            <span class="material-symbols-outlined text-xl"> inventory_2 </span>
            <span>Sản phẩm</span>
          </a>

          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> receipt_long </span>
            <span>Đơn hàng</span>
          </a>

          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> group </span>
            <span>Khách hàng</span>
          </a>

          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> insights </span>
            <span>Thống kê</span>
          </a>
        </nav>

        <div class="mt-auto border-t border-slate-800 px-4 py-4">
          <button
            id="logoutBtn"
            class="flex w-full items-center justify-center gap-2 rounded-lg bg-slate-800 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-slate-700"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <span>Đăng xuất</span>
          </button>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 bg-slate-950">
        <!-- Top bar -->
        <header
          class="flex items-center justify-between border-b border-slate-800 px-4 md:px-8 py-4 bg-slate-950/80 backdrop-blur sticky top-0 z-20"
        >
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">
              Bảng quản trị
            </p>
            <h1 class="text-xl md:text-2xl font-semibold">Quản lý sản phẩm</h1>
            <p class="text-xs text-slate-500">
              Thêm, sửa, xoá và quản lý toàn bộ sản phẩm trong hệ thống.
            </p>
          </div>

          <div class="flex items-center gap-4">
            <div class="hidden sm:flex flex-col items-end">
              <p class="text-sm font-medium" id="currentUserName">Admin</p>
              <p class="text-xs text-slate-500" id="currentUserEmail"></p>
            </div>
            <div
              class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-800 text-sm font-semibold"
            >
              A
            </div>
          </div>
        </header>

        <div class="px-4 md:px-8 py-6 flex flex-col gap-6">
          <!-- Filters & search -->
          <section
            class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4"
          >
            <div
              class="flex flex-1 items-center gap-2 rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2"
            >
              <span class="material-symbols-outlined text-slate-500">
                search
              </span>
              <input
                id="searchInput"
                type="text"
                placeholder="Tìm kiếm sản phẩm..."
                class="bg-transparent text-sm flex-1 outline-none placeholder:text-slate-500"
              />
            </div>

            <select
              id="categoryFilter"
              class="h-10 rounded-lg border border-slate-800 bg-slate-900/60 px-3 text-sm text-slate-200"
            >
              <option value="">Tất cả danh mục</option>
            </select>

            <select
              id="statusFilter"
              class="h-10 rounded-lg border border-slate-800 bg-slate-900/60 px-3 text-sm text-slate-200"
            >
              <option value="">Tất cả trạng thái</option>
              <option value="in_stock">Còn hàng</option>
              <option value="out_of_stock">Hết hàng</option>
            </select>
          </section>

          <!-- Main grid -->
          <section class="grid grid-cols-1 xl:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] gap-6">
            <!-- Products table -->
            <div
              class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl overflow-hidden"
            >
              <div
                class="flex items-center justify-between px-4 md:px-6 py-3 border-b border-slate-800"
              >
                <p class="text-sm font-semibold">Danh sách sản phẩm</p>
                <p class="text-xs text-slate-500">
                  Hiển thị
                  <span id="productCount" class="font-semibold text-slate-200"
                    >0</span
                  >
                  sản phẩm
                </p>
              </div>

              <div class="overflow-auto scrollbar-thin max-h-[520px]">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-900/80 sticky top-0 z-10">
                    <tr class="text-left text-xs text-slate-400 uppercase">
                      <th class="px-4 md:px-6 py-3 font-medium">Sản phẩm</th>
                      <th class="px-4 md:px-6 py-3 font-medium">Giá</th>
                      <th class="px-4 md:px-6 py-3 font-medium">Danh mục</th>
                      <th class="px-4 md:px-6 py-3 font-medium">Tồn kho</th>
                      <th class="px-4 md:px-6 py-3 font-medium">Trạng thái</th>
                      <th class="px-4 md:px-6 py-3 font-medium text-right">
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody id="productTableBody" class="divide-y divide-slate-800">
                    <!-- JS render rows -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Right column: add product & categories -->
            <div class="flex flex-col gap-6">
              <!-- Add product -->
              <div
                class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl"
              >
                <div
                  class="flex items-center justify-between px-4 md:px-6 py-3 border-b border-slate-800"
                >
                  <p class="text-sm font-semibold">Thêm sản phẩm mới</p>
                </div>

                <form
                  id="productForm"
                  class="px-4 md:px-6 py-4 flex flex-col gap-3"
                  enctype="multipart/form-data"
                >
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-xs text-slate-400">Tên sản phẩm</label>
                      <input
                        name="name"
                        id="productName"
                        required
                        class="mt-1 h-10 w-full rounded-lg border border-slate-800 bg-slate-950/50 px-3 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                        placeholder="Ví dụ: Basic Tee"
                      />
                    </div>
                    <div>
                      <label class="text-xs text-slate-400">Mã sản phẩm (SKU)</label>
                      <input
                        name="sku"
                        id="productSku"
                        class="mt-1 h-10 w-full rounded-lg border border-slate-800 bg-slate-950/50 px-3 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                        placeholder="SKU tuỳ chọn"
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-xs text-slate-400">Giá</label>
                      <input
                        name="price"
                        id="productPrice"
                        type="number"
                        step="0.01"
                        min="0"
                        required
                        class="mt-1 h-10 w-full rounded-lg border border-slate-800 bg-slate-950/50 px-3 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                        placeholder="0"
                      />
                    </div>
                    <div>
                      <label class="text-xs text-slate-400">Số lượng tồn</label>
                      <input
                        name="quantity"
                        id="productQuantity"
                        type="number"
                        min="0"
                        required
                        class="mt-1 h-10 w-full rounded-lg border border-slate-800 bg-slate-950/50 px-3 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                        placeholder="0"
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-xs text-slate-400">Danh mục</label>
                      <select
                        name="category"
                        id="productCategory"
                        required
                        class="mt-1 h-10 w-full rounded-lg border border-slate-800 bg-slate-950/50 px-3 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                      >
                        <option value="">Chọn danh mục</option>
                      </select>
                    </div>
                    <div>
                      <label class="text-xs text-slate-400">Trạng thái</label>
                      <select
                        name="status"
                        id="productStatus"
                        class="mt-1 h-10 w-full rounded-lg border border-slate-800 bg-slate-950/50 px-3 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                      >
                        <option value="in_stock">Còn hàng</option>
                        <option value="out_of_stock">Hết hàng</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label class="text-xs text-slate-400">Ảnh sản phẩm</label>
                    <div
                      class="mt-1 flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-slate-700 bg-slate-950/40 px-4 py-6 text-center"
                    >
                      <p class="text-xs text-slate-500 mb-2">
                        Kéo & thả hoặc chọn ảnh (PNG/JPG, tối đa 10MB)
                      </p>
                      <input
                        type="file"
                        id="productImage"
                        name="image"
                        accept="image/*"
                        class="block w-full text-xs text-slate-400 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-2 file:text-xs file:font-medium file:text-slate-100 hover:file:bg-slate-700"
                      />
                    </div>
                  </div>

                  <p
                    id="productFormMessage"
                    class="hidden text-xs mt-1"
                  ></p>

                  <div class="flex justify-end gap-2 pt-2">
                    <button
                      type="button"
                      id="resetProductForm"
                      class="h-9 rounded-lg border border-slate-700 px-3 text-xs font-medium text-slate-200 hover:bg-slate-800"
                    >
                      Huỷ
                    </button>
                    <button
                      type="submit"
                      id="submitProductBtn"
                      class="h-9 rounded-lg bg-blue-600 px-4 text-xs font-semibold text-white hover:bg-blue-500"
                    >
                      Lưu sản phẩm
                    </button>
                  </div>
                </form>
              </div>

              <!-- Manage categories (hiển thị, không làm CRUD chi tiết để đơn giản) -->
              <div
                class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl"
              >
                <div
                  class="flex items-center justify-between px-4 md:px-6 py-3 border-b border-slate-800"
                >
                  <p class="text-sm font-semibold">Danh mục</p>
                </div>

                <div class="px-4 md:px-6 py-4 space-y-2 max-h-52 overflow-auto scrollbar-thin">
                  <div
                    id="categoryList"
                    class="flex flex-col gap-2 text-xs text-slate-200"
                  >
                    <!-- JS render category chips -->
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Google Icons (sử dụng chung với trang login) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <script>
      const token = localStorage.getItem("auth_token");
      const user = JSON.parse(localStorage.getItem("auth_user") || "null");

      // Nếu chưa đăng nhập thì quay lại /login
      if (!token) {
        window.location.href = "/login";
      }

      // Hiển thị thông tin user
      if (user) {
        document.getElementById("currentUserName").textContent =
          user.fullname || user.name || "Admin";
        document.getElementById("currentUserEmail").textContent =
          user.email || "";
      }

      const productTableBody = document.getElementById("productTableBody");
      const productCount = document.getElementById("productCount");
      const categoryFilter = document.getElementById("categoryFilter");
      const statusFilter = document.getElementById("statusFilter");
      const searchInput = document.getElementById("searchInput");
      const categoryList = document.getElementById("categoryList");
      const productCategorySelect = document.getElementById("productCategory");
      const productForm = document.getElementById("productForm");
      const productFormMessage = document.getElementById("productFormMessage");
      const resetProductFormButton = document.getElementById(
        "resetProductForm"
      );
      const logoutBtn = document.getElementById("logoutBtn");

      let allProducts = [];
      let allCategories = [];

      function formatCurrency(v) {
        const num = Number(v) || 0;
        return num.toLocaleString("vi-VN", {
          style: "currency",
          currency: "VND",
          maximumFractionDigits: 0,
        });
      }

      function renderProducts() {
        const search = searchInput.value.trim().toLowerCase();
        const catId = categoryFilter.value;
        const status = statusFilter.value;

        let filtered = allProducts.slice();

        if (search) {
          filtered = filtered.filter((p) =>
            (p.name || "").toLowerCase().includes(search)
          );
        }
        if (catId) {
          filtered = filtered.filter((p) => String(p.id_cat) === String(catId));
        }
        if (status) {
          filtered = filtered.filter((p) => {
            const quantity = Number(p.quantity || p.qty || 0);
            const isInStock = quantity > 0;
            return status === "in_stock" ? isInStock : !isInStock;
          });
        }

        productTableBody.innerHTML = "";

        if (!filtered.length) {
          productTableBody.innerHTML =
            '<tr><td colspan="6" class="px-6 py-6 text-center text-xs text-slate-500">Không có sản phẩm nào.</td></tr>';
          productCount.textContent = "0";
          return;
        }

        filtered.forEach((p) => {
          const quantity = Number(p.quantity || p.qty || 0);
          const isInStock = quantity > 0;
          const statusLabel = isInStock ? "Còn hàng" : "Hết hàng";
          const statusColor = isInStock
            ? "bg-emerald-500/10 text-emerald-400 border-emerald-500/40"
            : "bg-rose-500/10 text-rose-400 border-rose-500/40";

          const cat = allCategories.find(
            (c) => String(c._id || c.id) === String(p.id_cat)
          );

          const row = document.createElement("tr");
          row.className = "hover:bg-slate-900/80";
          row.innerHTML = `
            <td class="px-4 md:px-6 py-3">
              <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-md bg-slate-800 overflow-hidden flex items-center justify-center text-[10px] text-slate-500">
                  ${
                    p.image
                      ? `<img src="${p.image}" alt="${p.name}" class="h-full w-full object-cover" />`
                      : "IMG"
                  }
                </div>
                <div class="flex flex-col">
                  <span class="text-xs font-medium text-slate-100">${p.name}</span>
                  <span class="text-[11px] text-slate-500">SKU: ${
                    p.sku || p._id || "-"
                  }</span>
                </div>
              </div>
            </td>
            <td class="px-4 md:px-6 py-3 text-xs text-slate-100">
              ${formatCurrency(p.price)}
            </td>
            <td class="px-4 md:px-6 py-3 text-xs text-slate-300">
              ${cat ? cat.name : "-"}
            </td>
            <td class="px-4 md:px-6 py-3 text-xs text-slate-100">
              ${quantity}
            </td>
            <td class="px-4 md:px-6 py-3">
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-medium ${statusColor}">
                ${statusLabel}
              </span>
            </td>
            <td class="px-4 md:px-6 py-3 text-right">
              <button class="inline-flex items-center justify-center rounded-md border border-slate-700 bg-slate-900/60 px-2 py-1 text-[11px] text-slate-200 hover:bg-slate-800" data-id="${
                p._id
              }">
                Sửa
              </button>
            </td>
          `;
          productTableBody.appendChild(row);
        });

        productCount.textContent = String(filtered.length);
      }

      function renderCategories() {
        categoryFilter.innerHTML =
          '<option value="">Tất cả danh mục</option>';
        productCategorySelect.innerHTML =
          '<option value="">Chọn danh mục</option>';
        categoryList.innerHTML = "";

        allCategories.forEach((c) => {
          const id = c._id || c.id;
          const optionFilter = document.createElement("option");
          optionFilter.value = id;
          optionFilter.textContent = c.name;
          categoryFilter.appendChild(optionFilter);

          const optionProduct = document.createElement("option");
          optionProduct.value = id;
          optionProduct.textContent = c.name;
          productCategorySelect.appendChild(optionProduct);

          const chip = document.createElement("div");
          chip.className =
            "flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/40 px-3 py-2";
          chip.innerHTML = `
            <span class="text-xs">${c.name}</span>
            <span class="text-[10px] text-slate-500">ID: ${id}</span>
          `;
          categoryList.appendChild(chip);
        });
      }

      async function loadCategories() {
        try {
          const res = await fetch("/api/category/list");
          const data = await res.json();
          if (Array.isArray(data.data)) {
            allCategories = data.data;
          } else if (Array.isArray(data)) {
            allCategories = data;
          } else {
            allCategories = [];
          }
          renderCategories();
        } catch (err) {
          console.error("Load categories error", err);
        }
      }

      async function loadProducts() {
        try {
          const res = await fetch("/api/product/list");
          const data = await res.json();
          if (Array.isArray(data.data)) {
            allProducts = data.data;
          } else if (Array.isArray(data)) {
            allProducts = data;
          } else {
            allProducts = [];
          }
          renderProducts();
        } catch (err) {
          console.error("Load products error", err);
        }
      }

      searchInput.addEventListener("input", () => renderProducts());
      categoryFilter.addEventListener("change", () => renderProducts());
      statusFilter.addEventListener("change", () => renderProducts());

      resetProductFormButton.addEventListener("click", () => {
        productForm.reset();
        productFormMessage.classList.add("hidden");
      });

      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        productFormMessage.classList.remove("hidden");
        productFormMessage.textContent = "Đang lưu sản phẩm...";
        productFormMessage.className =
          "block text-xs mt-1 text-amber-400";

        const formData = new FormData(productForm);
        // map field theo backend (tuỳ thuộc pCtrl.AddProduct)
        // ví dụ: name, price, quantity, id_cat, description, image
        if (formData.has("category")) {
          formData.set("id_cat", formData.get("category"));
          formData.delete("category");
        }

        try {
          const res = await fetch("/api/product/add", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });
          const data = await res.json().catch(() => ({}));

          if (res.ok) {
            productFormMessage.textContent =
              "Đã thêm sản phẩm thành công!";
            productFormMessage.className =
              "block text-xs mt-1 text-emerald-400";
            productForm.reset();
            await loadProducts();
          } else {
            const msg =
              data?.message || data?.error || "Không thể thêm sản phẩm.";
            productFormMessage.textContent = msg;
            productFormMessage.className =
              "block text-xs mt-1 text-rose-400";
          }
        } catch (err) {
          console.error(err);
          productFormMessage.textContent =
            "Lỗi kết nối server. Vui lòng thử lại.";
          productFormMessage.className =
            "block text-xs mt-1 text-rose-400";
        }
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("auth_user");
        window.location.href = "/login";
      });

      // Khởi chạy
      loadCategories();
      loadProducts();
    </script>
  </body>
</html>


