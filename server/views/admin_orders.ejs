<!DOCTYPE html>
<html class="dark" lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Quản lý đơn hàng - Admin</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.8);
        border-radius: 9999px;
      }
    </style>
  </head>

  <body class="bg-slate-950 text-slate-100">
    <div class="flex min-h-screen">
      <!-- Mobile menu button -->
      <button
        id="mobileMenuBtn"
        class="md:hidden fixed top-4 left-4 z-30 p-2 rounded-lg bg-slate-800 text-slate-100 hover:bg-slate-700"
      >
        <span class="material-symbols-outlined text-xl">menu</span>
      </button>

      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="hidden md:flex w-64 flex-col border-r border-slate-800 bg-slate-950/80 backdrop-blur fixed left-0 top-0 h-screen z-20 overflow-y-auto"
      >
        <!-- Close button for mobile -->
        <button
          id="closeSidebarBtn"
          class="md:hidden absolute top-4 right-4 p-2 rounded-lg bg-slate-800 text-slate-100 hover:bg-slate-700"
        >
          <span class="material-symbols-outlined text-xl">close</span>
        </button>
        <div class="flex items-center gap-3 px-6 pt-6 pb-4">
          <div
            class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-600 text-lg font-black"
          >
            CH
          </div>
          <div>
            <p class="text-sm text-slate-400">Admin</p>
            <p class="text-base font-semibold">ClosetHub Panel</p>
          </div>
        </div>

        <nav class="mt-4 flex-1 px-3 space-y-1">
          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl">space_dashboard</span>
            <span>Dashboard</span>
          </a>

          <a
            href="/admin"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> inventory_2 </span>
            <span>Sản phẩm</span>
          </a>

          <a
            href="/admin/orders"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm bg-slate-800 text-white"
          >
            <span class="material-symbols-outlined text-xl"> receipt_long </span>
            <span>Đơn hàng</span>
          </a>

          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> group </span>
            <span>Khách hàng</span>
          </a>

          <a
            href="#"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> insights </span>
            <span>Thống kê</span>
          </a>
        </nav>

        <div class="mt-auto border-t border-slate-800 px-4 py-4">
          <button
            id="logoutBtn"
            class="flex w-full items-center justify-center gap-2 rounded-lg bg-slate-800 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-slate-700"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <span>Đăng xuất</span>
          </button>
        </div>
      </aside>

      <!-- Sidebar overlay for mobile -->
      <div
        id="sidebarOverlay"
        class="hidden fixed inset-0 bg-black/50 z-10 md:hidden"
      ></div>

      <!-- Main content -->
      <main class="flex-1 bg-slate-950 md:ml-64">
        <!-- Top bar -->
        <header
          class="flex items-center justify-between border-b border-slate-800 px-4 md:px-8 py-4 bg-slate-950/80 backdrop-blur sticky top-0 z-20"
        >
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">
              Bảng quản trị
            </p>
            <h1 class="text-xl md:text-2xl font-semibold">Quản lý đơn hàng</h1>
            <p class="text-xs text-slate-500">
              Xem danh sách hóa đơn và chi tiết từng giao dịch trong hệ thống.
            </p>
          </div>

          <div class="flex items-center gap-4">
            <div class="hidden sm:flex flex-col items-end">
              <p class="text-sm font-medium" id="currentUserName">Admin</p>
              <p class="text-xs text-slate-500" id="currentUserEmail"></p>
            </div>
            <div
              class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-800 text-sm font-semibold"
            >
              A
            </div>
          </div>
        </header>

        <div class="px-4 md:px-8 py-6 flex flex-col gap-6 h-[calc(100vh-120px)]">
          <!-- Filters & search -->
          <section
            class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4"
          >
            <div
              class="flex flex-1 items-center gap-2 rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2"
            >
              <span class="material-symbols-outlined text-slate-500">
                search
              </span>
              <input
                id="searchInput"
                type="text"
                placeholder="Tìm kiếm đơn hàng..."
                class="bg-transparent text-sm flex-1 outline-none placeholder:text-slate-500"
              />
            </div>

            <select
              id="dateFilter"
              class="h-10 rounded-lg border border-slate-800 bg-slate-900/60 px-3 text-sm text-slate-200"
            >
              <option value="">Tất cả thời gian</option>
              <option value="today">Hôm nay</option>
              <option value="week">Tuần này</option>
              <option value="month">Tháng này</option>
            </select>
          </section>

          <!-- Orders table -->
          <section class="flex-1 min-h-0">
            <div
              class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl overflow-hidden flex flex-col h-full"
            >
              <div
                class="flex items-center justify-between px-4 md:px-6 py-3 border-b border-slate-800"
              >
                <p class="text-sm font-semibold">Danh sách đơn hàng</p>
                <p class="text-xs text-slate-500">
                  Hiển thị
                  <span id="orderCount" class="font-semibold text-slate-200"
                    >0</span
                  >
                  đơn hàng
                </p>
              </div>

              <div class="overflow-auto scrollbar-thin flex-1">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-900/80 sticky top-0 z-10">
                    <tr class="text-left text-xs text-slate-400 uppercase">
                      <th class="px-4 py-3 font-medium">Mã đơn</th>
                      <th class="px-4 py-3 font-medium">Khách hàng</th>
                      <th class="px-4 py-3 font-medium">Ngày đặt</th>
                      <th class="px-4 py-3 font-medium">Số sản phẩm</th>
                      <th class="px-4 py-3 font-medium">Tổng tiền</th>
                      <th class="px-4 py-3 font-medium">Trạng thái</th>
                      <th class="px-4 py-3 font-medium text-right">
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody id="orderTableBody" class="divide-y divide-slate-800">
                    <!-- JS render rows -->
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </main>

      <!-- Order Detail Modal -->
      <div
        id="orderDetailModal"
        class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
      >
        <div
          class="bg-slate-900 rounded-xl border border-slate-800 shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <!-- Modal Header -->
          <div
            class="flex items-center justify-between px-6 py-4 border-b border-slate-800"
          >
            <div>
              <h2 class="text-lg font-semibold">Chi tiết đơn hàng</h2>
              <p class="text-xs text-slate-500" id="modalOrderId"></p>
            </div>
            <button
              id="closeModalBtn"
              class="p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white"
            >
              <span class="material-symbols-outlined text-xl">close</span>
            </button>
          </div>

          <!-- Modal Content -->
          <div class="overflow-auto scrollbar-thin flex-1 px-6 py-4">
            <div id="orderDetailContent" class="space-y-6">
              <!-- Loading state -->
              <div class="text-center py-8">
                <p class="text-slate-400">Đang tải...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    <!-- Google Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <script>
      const token = localStorage.getItem("auth_token");
      const user = JSON.parse(localStorage.getItem("auth_user") || "null");

      // Nếu chưa đăng nhập thì quay lại /login
      if (!token) {
        window.location.href = "/login";
      }

      // Hiển thị thông tin user
      if (user) {
        document.getElementById("currentUserName").textContent =
          user.fullname || user.name || "Admin";
        document.getElementById("currentUserEmail").textContent =
          user.email || "";
      }

      const orderTableBody = document.getElementById("orderTableBody");
      const orderCount = document.getElementById("orderCount");
      const searchInput = document.getElementById("searchInput");
      const dateFilter = document.getElementById("dateFilter");
      const orderDetailModal = document.getElementById("orderDetailModal");
      const orderDetailContent = document.getElementById("orderDetailContent");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const modalOrderId = document.getElementById("modalOrderId");
      const logoutBtn = document.getElementById("logoutBtn");
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const closeSidebarBtn = document.getElementById("closeSidebarBtn");

      let allOrders = [];

      // Mobile menu toggle
      function toggleMobileMenu() {
        if (sidebar && sidebarOverlay) {
          const isHidden = sidebar.classList.contains("hidden");
          if (isHidden) {
            sidebar.classList.remove("hidden");
            sidebar.classList.add("flex");
            sidebarOverlay.classList.remove("hidden");
          } else {
            sidebar.classList.add("hidden");
            sidebar.classList.remove("flex");
            sidebarOverlay.classList.add("hidden");
          }
        }
      }

      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener("click", toggleMobileMenu);
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener("click", toggleMobileMenu);
      }

      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener("click", toggleMobileMenu);
      }

      if (sidebar) {
        sidebar.querySelectorAll("nav a").forEach((link) => {
          link.addEventListener("click", () => {
            if (window.innerWidth < 768) {
              toggleMobileMenu();
            }
          });
        });
      }

      function formatCurrency(v) {
        const num = Number(v) || 0;
        return num.toLocaleString("vi-VN", {
          style: "currency",
          currency: "VND",
          maximumFractionDigits: 0,
        });
      }

      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleString("vi-VN", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function renderOrders() {
        const search = searchInput.value.trim().toLowerCase();
        const dateFilterValue = dateFilter.value;

        let filtered = allOrders.slice();

        // Filter by search
        if (search) {
          filtered = filtered.filter((order) => {
            const billId = (order.bill_id || "").toString().toLowerCase();
            const customerName = (order.customer?.name || "").toLowerCase();
            const customerEmail = (order.customer?.email || "").toLowerCase();
            const customerPhone = (order.customer?.phone || "").toLowerCase();
            return (
              billId.includes(search) ||
              customerName.includes(search) ||
              customerEmail.includes(search) ||
              customerPhone.includes(search)
            );
          });
        }

        // Filter by date
        if (dateFilterValue) {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          const monthAgo = new Date(today);
          monthAgo.setMonth(monthAgo.getMonth() - 1);

          filtered = filtered.filter((order) => {
            const orderDate = new Date(order.created_date);
            switch (dateFilterValue) {
              case "today":
                return orderDate >= today;
              case "week":
                return orderDate >= weekAgo;
              case "month":
                return orderDate >= monthAgo;
              default:
                return true;
            }
          });
        }

        orderTableBody.innerHTML = "";

        if (!filtered.length) {
          orderTableBody.innerHTML =
            '<tr><td colspan="7" class="px-4 py-8 text-center text-xs text-slate-500">Không có đơn hàng nào.</td></tr>';
          orderCount.textContent = "0";
          return;
        }

        filtered.forEach((order) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-slate-900/80";
          
          const billIdShort = order.bill_id ? order.bill_id.toString().substring(0, 8) : "-";
          const customerName = order.customer?.name || "Khách hàng";
          const customerEmail = order.customer?.email || "";
          const productCount = order.products?.length || 0;
          const totalAmount = order.total_amount || 0;

          row.innerHTML = `
            <td class="px-4 py-3">
              <span class="text-xs font-mono text-blue-400">#${billIdShort}</span>
            </td>
            <td class="px-4 py-3">
              <div class="flex flex-col">
                <span class="text-xs font-medium text-slate-100">${customerName}</span>
                ${customerEmail ? `<span class="text-[10px] text-slate-500">${customerEmail}</span>` : ""}
              </div>
            </td>
            <td class="px-4 py-3 text-xs text-slate-300">
              ${formatDate(order.created_date)}
            </td>
            <td class="px-4 py-3 text-xs text-slate-100">
              ${productCount} sản phẩm
            </td>
            <td class="px-4 py-3 text-xs font-semibold text-slate-100">
              ${formatCurrency(totalAmount)}
            </td>
            <td class="px-4 py-3">
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-medium bg-emerald-500/10 text-emerald-400 border-emerald-500/40">
                Đã đặt hàng
              </span>
            </td>
            <td class="px-4 py-3 text-right">
              <button
                onclick="viewOrderDetail('${order.bill_id}')"
                class="inline-flex items-center justify-center rounded-md border border-slate-700 bg-slate-900/60 px-3 py-1.5 text-[10px] text-slate-200 hover:bg-slate-800 hover:text-white transition-colors"
              >
                <span class="material-symbols-outlined text-sm mr-1">visibility</span>
                Xem chi tiết
              </button>
            </td>
          `;
          orderTableBody.appendChild(row);
        });

        orderCount.textContent = String(filtered.length);
      }

      async function loadOrders() {
        try {
          const res = await fetch("/api/order/list/admin", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await res.json();
          if (Array.isArray(data.data)) {
            allOrders = data.data;
          } else if (Array.isArray(data)) {
            allOrders = data;
          } else {
            allOrders = [];
          }
          renderOrders();
        } catch (err) {
          console.error("Load orders error", err);
          alert("Lỗi khi tải danh sách đơn hàng. Vui lòng thử lại.");
        }
      }

      function viewOrderDetail(billId) {
        const order = allOrders.find((o) => o.bill_id === billId);
        if (!order) {
          alert("Không tìm thấy đơn hàng!");
          return;
        }

        modalOrderId.textContent = `Mã đơn: #${billId}`;
        orderDetailContent.innerHTML = `
          <!-- Customer Info -->
          <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-base">person</span>
              Thông tin khách hàng
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
              <div>
                <p class="text-slate-500 mb-1">Tên khách hàng</p>
                <p class="text-slate-100 font-medium">${order.customer?.name || "N/A"}</p>
              </div>
              <div>
                <p class="text-slate-500 mb-1">Email</p>
                <p class="text-slate-100">${order.customer?.email || "N/A"}</p>
              </div>
              <div>
                <p class="text-slate-500 mb-1">Số điện thoại</p>
                <p class="text-slate-100">${order.customer?.phone || "N/A"}</p>
              </div>
              <div>
                <p class="text-slate-500 mb-1">Mã khách hàng</p>
                <p class="text-slate-100 font-mono text-[10px]">${order.customer?.id || "N/A"}</p>
              </div>
            </div>
          </div>

          <!-- Delivery Info -->
          <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-base">local_shipping</span>
              Thông tin giao hàng
            </h3>
            <div class="space-y-2 text-xs">
              <div>
                <p class="text-slate-500 mb-1">Địa chỉ giao hàng</p>
                <p class="text-slate-100">${order.delivery?.address || order.address || "N/A"}</p>
              </div>
              <div>
                <p class="text-slate-500 mb-1">Phương thức vận chuyển</p>
                <p class="text-slate-100">${order.delivery?.method || "N/A"}</p>
              </div>
            </div>
          </div>

          <!-- Order Info -->
          <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-base">receipt</span>
              Thông tin đơn hàng
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
              <div>
                <p class="text-slate-500 mb-1">Ngày đặt hàng</p>
                <p class="text-slate-100">${formatDate(order.created_date)}</p>
              </div>
              <div>
                <p class="text-slate-500 mb-1">Phương thức thanh toán</p>
                <p class="text-slate-100">${order.payment || "N/A"}</p>
              </div>
            </div>
          </div>

          <!-- Products List -->
          <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-base">shopping_bag</span>
              Sản phẩm (${order.products?.length || 0})
            </h3>
            <div class="space-y-3">
              ${(order.products || []).map((product, index) => {
                const imageUrl = product.image 
                  ? `/images/products/${product.image}` 
                  : null;
                return `
                  <div class="flex gap-3 p-3 rounded-lg border border-slate-800 bg-slate-900/40">
                    <div class="h-16 w-16 rounded-md bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0">
                      ${
                        imageUrl
                          ? `<img src="${imageUrl}" alt="${product.name}" class="h-full w-full object-cover" onerror="this.parentElement.innerHTML='IMG'" />`
                          : '<span class="text-[10px] text-slate-500">IMG</span>'
                      }
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="text-xs font-medium text-slate-100 mb-1">${product.name || "N/A"}</p>
                      ${product.size || product.color ? `
                        <p class="text-[10px] text-slate-500 mb-1">
                          ${product.size ? `Size: ${product.size}` : ""}${product.size && product.color ? " | " : ""}${product.color ? `Màu: ${product.color}` : ""}
                        </p>
                      ` : ""}
                      <div class="flex items-center justify-between mt-2">
                        <p class="text-[10px] text-slate-500">
                          Số lượng: <span class="text-slate-300 font-medium">${product.quantity || 0}</span>
                        </p>
                        <p class="text-xs font-semibold text-slate-100">
                          ${formatCurrency(product.amount || 0)}
                        </p>
                      </div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          </div>

          <!-- Summary -->
          <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-base">calculate</span>
              Tổng kết
            </h3>
            <div class="space-y-2 text-xs">
              <div class="flex justify-between text-slate-400">
                <span>Tổng tiền sản phẩm:</span>
                <span class="text-slate-200">${formatCurrency(order.subtotal || 0)}</span>
              </div>
              ${order.shipping_fee > 0 ? `
                <div class="flex justify-between text-slate-400">
                  <span>Phí vận chuyển:</span>
                  <span class="text-slate-200">${formatCurrency(order.shipping_fee || 0)}</span>
                </div>
              ` : ""}
              <div class="flex justify-between text-sm font-semibold text-slate-100 pt-2 border-t border-slate-800">
                <span>Tổng cộng:</span>
                <span class="text-blue-400">${formatCurrency(order.total_amount || 0)}</span>
              </div>
            </div>
          </div>
        `;

        orderDetailModal.classList.remove("hidden");
      }

      function closeModal() {
        orderDetailModal.classList.add("hidden");
      }

      // Event listeners
      searchInput.addEventListener("input", () => renderOrders());
      dateFilter.addEventListener("change", () => renderOrders());
      closeModalBtn.addEventListener("click", closeModal);
      orderDetailModal.addEventListener("click", (e) => {
        if (e.target === orderDetailModal) {
          closeModal();
        }
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("auth_user");
        window.location.href = "/login";
      });

      // Make viewOrderDetail available globally
      window.viewOrderDetail = viewOrderDetail;

      // Khởi chạy
      loadOrders();
    </script>
  </body>
</html>


