<!DOCTYPE html>
<html class="dark" lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Thống kê báo cáo doanh thu - Admin</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        overflow-x: hidden;
        max-width: 100vw;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.8);
        border-radius: 9999px;
      }
    </style>
  </head>

  <body class="bg-slate-950 text-slate-100">
    <div class="flex min-h-screen">
      <!-- Mobile menu button -->
      <button
        id="mobileMenuBtn"
        class="md:hidden fixed top-4 left-4 z-30 p-2 rounded-lg bg-slate-800 text-slate-100 hover:bg-slate-700"
      >
        <span class="material-symbols-outlined text-xl">menu</span>
      </button>

      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="hidden md:flex w-64 flex-col border-r border-slate-800 bg-slate-950/80 backdrop-blur fixed left-0 top-0 h-screen z-20 overflow-y-auto"
      >
        <!-- Close button for mobile -->
        <button
          id="closeSidebarBtn"
          class="md:hidden absolute top-4 right-4 p-2 rounded-lg bg-slate-800 text-slate-100 hover:bg-slate-700"
        >
          <span class="material-symbols-outlined text-xl">close</span>
        </button>
        <div class="flex items-center gap-3 px-6 pt-6 pb-4">
          <div
            class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-600 text-lg font-black"
          >
            CH
          </div>
          <div>
            <p class="text-sm text-slate-400">Admin</p>
            <p class="text-base font-semibold">ClosetHub Panel</p>
          </div>
        </div>

        <nav class="mt-4 flex-1 px-3 space-y-1">
          <a
            href="/admin/dashboard"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"
              >space_dashboard</span
            >
            <span>Dashboard</span>
          </a>

          <a
            href="/admin/products"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> inventory_2 </span>
            <span>Sản phẩm</span>
          </a>

          <a
            href="/admin/orders"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl">
              receipt_long
            </span>
            <span>Đơn hàng</span>
          </a>

          <a
            href="/admin/customers"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> group </span>
            <span>Khách hàng</span>
          </a>

          <a
            href="/admin/statistics"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm bg-slate-800 text-white"
          >
            <span class="material-symbols-outlined text-xl"> insights </span>
            <span>Thống kê</span>
          </a>

          <a
            href="/admin/banners"
            class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
          >
            <span class="material-symbols-outlined text-xl"> image </span>
            <span>Banner</span>
          </a>
        </nav>

        <div class="mt-auto border-t border-slate-800 px-4 py-4">
          <button
            id="logoutBtn"
            class="flex w-full items-center justify-center gap-2 rounded-lg bg-slate-800 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-slate-700"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <span>Đăng xuất</span>
          </button>
        </div>
      </aside>

      <!-- Sidebar overlay for mobile -->
      <div
        id="sidebarOverlay"
        class="hidden fixed inset-0 bg-black/50 z-10 md:hidden"
      ></div>

      <!-- Main content -->
      <main class="flex-1 bg-slate-950 md:ml-64 max-w-full overflow-x-hidden">
        <!-- Top bar -->
        <header
          class="flex items-center justify-between border-b border-slate-800 px-4 md:px-8 py-4 bg-slate-950/80 backdrop-blur sticky top-0 z-20"
        >
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">
              Bảng quản trị
            </p>
            <h1 class="text-xl md:text-2xl font-semibold">
              Thống kê báo cáo doanh thu
            </h1>
            <p class="text-xs text-slate-500">
              Xem doanh thu theo khoảng ngày và top sản phẩm bán chạy.
            </p>
          </div>

          <div class="flex items-center gap-4">
            <div class="hidden sm:flex flex-col items-end">
              <p class="text-sm font-medium" id="currentUserName">Admin</p>
              <p class="text-xs text-slate-500" id="currentUserEmail"></p>
            </div>
            <div
              class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-800 text-sm font-semibold"
            >
              A
            </div>
          </div>
        </header>

        <div class="px-4 md:px-8 py-6 flex flex-col gap-6 max-w-full overflow-x-hidden">
          <!-- Date Range Selector -->
          <section
            class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4 max-w-full"
          >
            <div class="flex items-center gap-3 flex-wrap max-w-full">
              <span class="text-sm text-slate-400">Chọn khoảng thời gian:</span>
              <div class="flex items-center gap-2">
                <label class="text-xs text-slate-400">Từ ngày:</label>
                <input
                  type="date"
                  id="startDate"
                  class="px-3 py-2 rounded-lg border border-slate-800 bg-slate-900/60 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs text-slate-400">Đến ngày:</label>
                <input
                  type="date"
                  id="endDate"
                  class="px-3 py-2 rounded-lg border border-slate-800 bg-slate-900/60 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <button
                id="applyDateFilter"
                class="px-4 py-2 rounded-lg bg-blue-600 text-sm font-medium text-white hover:bg-blue-700 transition-colors"
              >
                Áp dụng
              </button>
            </div>
          </section>

          <!-- Summary Cards -->
          <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-slate-500 mb-1">Tổng doanh thu</p>
                  <p
                    class="text-xl font-semibold text-blue-400"
                    id="totalRevenue"
                  >
                    0 đ
                  </p>
                </div>
                <div
                  class="flex h-12 w-12 items-center justify-center rounded-lg bg-blue-500/10"
                >
                  <span class="material-symbols-outlined text-blue-400"
                    >payments</span
                  >
                </div>
              </div>
            </div>

            <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-slate-500 mb-1">Tổng đơn hàng</p>
                  <p
                    class="text-xl font-semibold text-emerald-400"
                    id="totalOrders"
                  >
                    0
                  </p>
                </div>
                <div
                  class="flex h-12 w-12 items-center justify-center rounded-lg bg-emerald-500/10"
                >
                  <span class="material-symbols-outlined text-emerald-400"
                    >receipt_long</span
                  >
                </div>
              </div>
            </div>

            <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-slate-500 mb-1">
                    Giá trị đơn trung bình
                  </p>
                  <p
                    class="text-xl font-semibold text-amber-400"
                    id="avgOrderValue"
                  >
                    0 đ
                  </p>
                </div>
                <div
                  class="flex h-12 w-12 items-center justify-center rounded-lg bg-amber-500/10"
                >
                  <span class="material-symbols-outlined text-amber-400"
                    >trending_up</span
                  >
                </div>
              </div>
            </div>
          </section>

          <!-- Revenue Chart -->
          <section
            class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl p-6 max-w-full overflow-x-hidden"
          >
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-sm font-semibold">Biểu đồ doanh thu</h2>
            </div>
            <div class="h-80">
              <canvas id="revenueChart"></canvas>
            </div>
          </section>

          <!-- Top Selling Products -->
          <section
            class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl overflow-hidden max-w-full"
          >
            <div
              class="flex items-center justify-between px-4 md:px-6 py-3 border-b border-slate-800"
            >
              <h2 class="text-sm font-semibold">Top sản phẩm bán chạy</h2>
              <p class="text-xs text-slate-500">
                Hiển thị
                <span id="topProductCount" class="font-semibold text-slate-200"
                  >0</span
                >
                sản phẩm
              </p>
            </div>

            <div class="overflow-x-auto scrollbar-thin max-w-full">
              <table class="w-full text-sm" style="min-width: 600px;">
                <thead class="bg-slate-900/80 sticky top-0 z-10">
                  <tr class="text-left text-xs text-slate-400 uppercase">
                    <th class="px-4 py-3 font-medium">Hạng</th>
                    <th class="px-4 py-3 font-medium">Hình ảnh</th>
                    <th class="px-4 py-3 font-medium">Tên sản phẩm</th>
                    <th class="px-4 py-3 font-medium">Đã bán</th>
                    <th class="px-4 py-3 font-medium">Tồn kho</th>
                    <th class="px-4 py-3 font-medium">Giá</th>
                  </tr>
                </thead>
                <tbody
                  id="topProductsTableBody"
                  class="divide-y divide-slate-800"
                >
                  <!-- JS render rows -->
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Google Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <script>
      const token = localStorage.getItem("auth_token");
      const user = JSON.parse(localStorage.getItem("auth_user") || "null");

      // Nếu chưa đăng nhập thì quay lại /login
      if (!token) {
        window.location.href = "/login";
      }

      // Hiển thị thông tin user
      if (user) {
        document.getElementById("currentUserName").textContent =
          user.fullname || user.name || "Admin";
        document.getElementById("currentUserEmail").textContent =
          user.email || "";
      }

      const startDateInput = document.getElementById("startDate");
      const endDateInput = document.getElementById("endDate");
      const applyDateFilterBtn = document.getElementById("applyDateFilter");
      const totalRevenueEl = document.getElementById("totalRevenue");
      const totalOrdersEl = document.getElementById("totalOrders");
      const avgOrderValueEl = document.getElementById("avgOrderValue");
      const topProductsTableBody = document.getElementById(
        "topProductsTableBody"
      );
      const topProductCount = document.getElementById("topProductCount");
      const logoutBtn = document.getElementById("logoutBtn");
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const closeSidebarBtn = document.getElementById("closeSidebarBtn");

      let revenueChart = null;

      // Set default date range (30 days ago to today)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      // Format dates as YYYY-MM-DD
      const formatDateForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      startDateInput.value = formatDateForInput(thirtyDaysAgo);
      endDateInput.value = formatDateForInput(today);

      // Mobile menu toggle
      function toggleMobileMenu() {
        if (sidebar && sidebarOverlay) {
          const isHidden = sidebar.classList.contains("hidden");
          if (isHidden) {
            sidebar.classList.remove("hidden");
            sidebar.classList.add("flex");
            sidebarOverlay.classList.remove("hidden");
          } else {
            sidebar.classList.add("hidden");
            sidebar.classList.remove("flex");
            sidebarOverlay.classList.add("hidden");
          }
        }
      }

      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener("click", toggleMobileMenu);
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener("click", toggleMobileMenu);
      }

      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener("click", toggleMobileMenu);
      }

      if (sidebar) {
        sidebar.querySelectorAll("nav a").forEach((link) => {
          link.addEventListener("click", () => {
            if (window.innerWidth < 768) {
              toggleMobileMenu();
            }
          });
        });
      }

      function formatCurrency(v) {
        const num = Number(v) || 0;
        return num.toLocaleString("vi-VN", {
          style: "currency",
          currency: "VND",
          maximumFractionDigits: 0,
        });
      }

      async function loadRevenueStatistics(startDate, endDate) {
        try {
          if (!startDate || !endDate) {
            alert("Vui lòng chọn cả ngày bắt đầu và ngày kết thúc");
            return;
          }

          // Validate date range
          const start = new Date(startDate);
          const end = new Date(endDate);
          if (start > end) {
            alert("Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc");
            return;
          }

          const res = await fetch(
            `/api/statistics/revenue?start_date=${startDate}&end_date=${endDate}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          const data = await res.json();

          if (data.msg !== "OK") {
            alert(data.msg || "Lỗi khi tải thống kê doanh thu");
            return;
          }

          if (data.data && data.data.summary) {
            const summary = data.data.summary;
            totalRevenueEl.textContent = formatCurrency(
              summary.total_revenue || 0
            );
            totalOrdersEl.textContent = (
              summary.total_orders || 0
            ).toLocaleString("vi-VN");
            avgOrderValueEl.textContent = formatCurrency(
              summary.average_order_value || 0
            );
          }

          if (data.data && data.data.statistics) {
            renderRevenueChart(data.data.statistics);
          }
        } catch (err) {
          console.error("Load revenue statistics error", err);
          alert("Lỗi khi tải thống kê doanh thu. Vui lòng thử lại.");
        }
      }

      function renderRevenueChart(statistics) {
        const ctx = document.getElementById("revenueChart");

        if (revenueChart) {
          revenueChart.destroy();
        }

        const labels = statistics.map((s) => s.date || "");
        const revenues = statistics.map((s) => s.total_revenue || 0);
        const orderCounts = statistics.map((s) => s.order_count || 0);

        revenueChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Doanh thu (VNĐ)",
                data: revenues,
                borderColor: "rgb(59, 130, 246)",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                tension: 0.4,
                fill: true,
                yAxisID: "y",
              },
              {
                label: "Số đơn hàng",
                data: orderCounts,
                borderColor: "rgb(16, 185, 129)",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                tension: 0.4,
                fill: true,
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "rgb(226, 232, 240)",
                },
              },
            },
            scales: {
              x: {
                ticks: {
                  color: "rgb(148, 163, 184)",
                },
                grid: {
                  color: "rgba(148, 163, 184, 0.1)",
                },
              },
              y: {
                type: "linear",
                display: true,
                position: "left",
                ticks: {
                  color: "rgb(148, 163, 184)",
                  callback: function (value) {
                    return (value / 1000000).toFixed(1) + "M";
                  },
                },
                grid: {
                  color: "rgba(148, 163, 184, 0.1)",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                ticks: {
                  color: "rgb(148, 163, 184)",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });
      }

      async function loadTopSellingProducts(startDate = null, endDate = null) {
        try {
          let url = "/api/statistics/top-selling?limit=10";
          // Nếu có tham số ngày, thêm vào query
          if (startDate && endDate) {
            url += `&start_date=${startDate}&end_date=${endDate}`;
          }
          
          const res = await fetch(url, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await res.json();

          if (Array.isArray(data.data)) {
            renderTopProducts(data.data);
          } else {
            renderTopProducts([]);
          }
        } catch (err) {
          console.error("Load top selling products error", err);
          renderTopProducts([]);
        }
      }

      function renderTopProducts(products) {
        topProductsTableBody.innerHTML = "";

        if (!products || products.length === 0) {
          topProductsTableBody.innerHTML =
            '<tr><td colspan="6" class="px-4 py-8 text-center text-xs text-slate-500">Không có dữ liệu sản phẩm bán chạy.</td></tr>';
          topProductCount.textContent = "0";
          return;
        }

        products.forEach((product, index) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-slate-900/80";

          const imageUrl = product.image
            ? `/images/products/${product.image}`
            : null;

          const rankColor =
            index === 0
              ? "text-amber-400"
              : index === 1
              ? "text-slate-400"
              : index === 2
              ? "text-amber-600"
              : "text-slate-500";

          row.innerHTML = `
            <td class="px-4 py-3">
              <span class="text-sm font-semibold ${rankColor}">#${
            index + 1
          }</span>
            </td>
            <td class="px-4 py-3">
              <div class="h-12 w-12 rounded-md bg-slate-800 overflow-hidden flex items-center justify-center">
                ${
                  imageUrl
                    ? `<img src="${imageUrl}" alt="${product.name}" class="h-full w-full object-cover" onerror="this.parentElement.innerHTML='IMG'" />`
                    : '<span class="text-[10px] text-slate-500">IMG</span>'
                }
              </div>
            </td>
            <td class="px-4 py-3">
              <span class="text-xs font-medium text-slate-100">${
                product.name || "-"
              }</span>
            </td>
            <td class="px-4 py-3">
              <span class="text-xs text-emerald-400 font-semibold">${(
                product.total_sold || 0
              ).toLocaleString("vi-VN")}</span>
            </td>
            <td class="px-4 py-3">
              <span class="text-xs text-slate-300">${(
                product.quantity || 0
              ).toLocaleString("vi-VN")}</span>
            </td>
            <td class="px-4 py-3">
              <div class="flex flex-col">
                ${
                  product.min_price === product.max_price
                    ? `
                  <span class="text-xs text-slate-100 font-medium">${formatCurrency(
                    product.min_price || 0
                  )}</span>
                `
                    : `
                  <span class="text-xs text-slate-100 font-medium">${formatCurrency(
                    product.min_price || 0
                  )} - ${formatCurrency(
                    product.max_price || 0
                  )}</span>
                `
                }
              </div>
            </td>
          `;
          topProductsTableBody.appendChild(row);
        });

        topProductCount.textContent = String(products.length);
      }

      // Date filter button handler
      applyDateFilterBtn.addEventListener("click", () => {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        loadRevenueStatistics(startDate, endDate);
        // Cũng load lại top sản phẩm bán chạy với cùng khoảng thời gian
        loadTopSellingProducts(startDate, endDate);
      });

      // Allow Enter key to apply filter
      startDateInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyDateFilterBtn.click();
        }
      });

      endDateInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyDateFilterBtn.click();
        }
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("auth_user");
        window.location.href = "/login";
      });

      // Khởi chạy với date range mặc định
      loadRevenueStatistics(startDateInput.value, endDateInput.value);
      loadTopSellingProducts();
    </script>
  </body>
</html>
